"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[144],{3817:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"packages/nestjs-etcd","title":"NestJS etcd","description":"A NestJS module for integrating etcd3 distributed coordination services. This package provides leader election and distributed locking capabilities for NestJS applications.","source":"@site/content/packages/nestjs-etcd.mdx","sourceDirName":"packages","slug":"/packages/nestjs-etcd","permalink":"/packages/nestjs-etcd","draft":false,"unlisted":false,"editUrl":"https://github.com/GlobalArtInc/ecosystem/tree/main/docs/content/packages/nestjs-etcd.mdx","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5},"sidebar":"tutorialSidebar","previous":{"title":"NestJS Logger","permalink":"/packages/nestjs-logger"},"next":{"title":"Domain Driven Design","permalink":"/packages/ddd"}}');var r=i(7711),c=i(7025);const t={sidebar_position:5},l="NestJS etcd",o={},d=[{value:"Installation",id:"installation",level:2},{value:"Overview",id:"overview",level:2},{value:"Key Features",id:"key-features",level:2},{value:"Quick Start",id:"quick-start",level:2},{value:"Basic Setup",id:"basic-setup",level:3},{value:"Async Configuration",id:"async-configuration",level:3},{value:"Configuration",id:"configuration",level:2},{value:"EtcdModuleOptions",id:"etcdmoduleoptions",level:3},{value:"EtcdFeature",id:"etcdfeature",level:3},{value:"etcd3 Options",id:"etcd3-options",level:3},{value:"Leader Election",id:"leader-election",level:2},{value:"How It Works",id:"how-it-works",level:3},{value:"Basic Usage",id:"basic-usage",level:3},{value:"Use Cases",id:"use-cases",level:3},{value:"Leader Election Service API",id:"leader-election-service-api",level:3},{value:"Distributed Locking",id:"distributed-locking",level:2},{value:"Basic Usage",id:"basic-usage-1",level:3},{value:"Lock Options",id:"lock-options",level:3},{value:"Lock Methods",id:"lock-methods",level:3},{value:"<code>acquire(key: string, options?: LockOptions): Promise&lt;Lock&gt;</code>",id:"acquirekey-string-options-lockoptions-promiselock",level:4},{value:"<code>release(key: string): Promise&lt;void&gt;</code>",id:"releasekey-string-promisevoid",level:4},{value:"<code>isLocked(key: string): Promise&lt;boolean&gt;</code>",id:"islockedkey-string-promiseboolean",level:4},{value:"Use Cases",id:"use-cases-1",level:3},{value:"Best Practices",id:"best-practices",level:3},{value:"API Reference",id:"api-reference",level:2},{value:"Decorators",id:"decorators",level:3},{value:"<code>@InjectEtcdLeaderElectionService()</code>",id:"injectetcdleaderelectionservice",level:4},{value:"<code>@InjectEtcdDistributedLockService()</code>",id:"injectetcddistributedlockservice",level:4},{value:"<code>@InjectEtcdClient()</code>",id:"injectetcdclient",level:4},{value:"<code>@InjectEtcdId()</code>",id:"injectetcdid",level:4},{value:"Services",id:"services",level:3},{value:"LeaderElectionService",id:"leaderelectionservice",level:4},{value:"DistributedLockService",id:"distributedlockservice",level:4},{value:"LockOptions",id:"lockoptions",level:4},{value:"Advanced Usage",id:"advanced-usage",level:2},{value:"Custom etcd Operations",id:"custom-etcd-operations",level:3},{value:"Instance Identification",id:"instance-identification",level:3},{value:"Error Handling",id:"error-handling",level:2},{value:"Leader Election Errors",id:"leader-election-errors",level:3},{value:"Lock Acquisition Failures",id:"lock-acquisition-failures",level:3},{value:"Lock Release Errors",id:"lock-release-errors",level:3},{value:"Examples",id:"examples",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Connection Issues",id:"connection-issues",level:3},{value:"Lock Not Releasing",id:"lock-not-releasing",level:3},{value:"Leader Not Electing",id:"leader-not-electing",level:3},{value:"Best Practices",id:"best-practices-1",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,c.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"nestjs-etcd",children:"NestJS etcd"})}),"\n",(0,r.jsx)(n.p,{children:"A NestJS module for integrating etcd3 distributed coordination services. This package provides leader election and distributed locking capabilities for NestJS applications."}),"\n",(0,r.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",metastring:"npm2yarn",children:"npm install @globalart/nestjs-etcd etcd3\n"})}),"\n",(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"@globalart/nestjs-etcd"})," package provides a seamless integration with etcd3, enabling distributed coordination features in your NestJS applications. It offers two main features:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Leader Election"}),": Automatically elect a leader among multiple application instances"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Distributed Locking"}),": Acquire and release distributed locks across multiple instances"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"key-features",children:"Key Features"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Leader Election"})," - Automatic leader selection with failover support"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Distributed Locking"})," - Reliable distributed locks with TTL support"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Type-safe"})," - Full TypeScript support with proper type definitions"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Feature-based"})," - Enable only the features you need"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Global Module"})," - Available throughout your application"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"quick-start",children:"Quick Start"}),"\n",(0,r.jsx)(n.h3,{id:"basic-setup",children:"Basic Setup"}),"\n",(0,r.jsxs)(n.p,{children:["Import ",(0,r.jsx)(n.code,{children:"EtcdModule"})," in your root module:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { Module } from '@nestjs/common';\nimport { EtcdModule } from '@globalart/nestjs-etcd';\n\n@Module({\n  imports: [\n    EtcdModule.forRoot({\n      features: ['leaderElection', 'distributedLock'],\n      leaderElectionKey: 'my-app-leader',\n      etcdOptions: {\n        hosts: ['localhost:2379'],\n      },\n    }),\n  ],\n})\nexport class AppModule {}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"async-configuration",children:"Async Configuration"}),"\n",(0,r.jsxs)(n.p,{children:["For dynamic configuration, use ",(0,r.jsx)(n.code,{children:"forRootAsync"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { Module } from '@nestjs/common';\nimport { EtcdModule, EtcdModuleAsyncOptions } from '@globalart/nestjs-etcd';\nimport { ConfigModule, ConfigService } from '@nestjs/config';\n\n@Module({\n  imports: [\n    EtcdModule.forRootAsync({\n      imports: [ConfigModule],\n      useFactory: (configService: ConfigService) => ({\n        features: ['leaderElection', 'distributedLock'],\n        leaderElectionKey: configService.get('ETCD_LEADER_KEY'),\n        etcdOptions: {\n          hosts: configService.get('ETCD_HOSTS').split(','),\n        },\n      }),\n      inject: [ConfigService],\n    }),\n  ],\n})\nexport class AppModule {}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsx)(n.h3,{id:"etcdmoduleoptions",children:"EtcdModuleOptions"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Option"}),(0,r.jsx)(n.th,{children:"Type"}),(0,r.jsx)(n.th,{children:"Required"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"features"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"EtcdFeature[]"})}),(0,r.jsx)(n.td,{children:"No"}),(0,r.jsxs)(n.td,{children:["Array of features to enable: ",(0,r.jsx)(n.code,{children:"'leaderElection'"}),", ",(0,r.jsx)(n.code,{children:"'distributedLock'"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"leaderElectionKey"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"string"})}),(0,r.jsx)(n.td,{children:"No"}),(0,r.jsxs)(n.td,{children:["Key used for leader election (default: ",(0,r.jsx)(n.code,{children:"'etcd'"}),")"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"etcdOptions"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"IOptions"})}),(0,r.jsx)(n.td,{children:"Yes"}),(0,r.jsx)(n.td,{children:"etcd3 client configuration options"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"etcdfeature",children:"EtcdFeature"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"'leaderElection'"}),": Enables leader election functionality"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"'distributedLock'"}),": Enables distributed locking functionality"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"etcd3-options",children:"etcd3 Options"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"etcdOptions"})," parameter accepts all configuration options from the etcd3 library. Common options include:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"hosts"}),": Array of etcd server addresses (e.g., ",(0,r.jsx)(n.code,{children:"['localhost:2379']"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"auth"}),": Authentication credentials"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"namespace"}),": Key namespace prefix"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"grpcOptions"}),": gRPC client options"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Refer to the ",(0,r.jsx)(n.a,{href:"https://github.com/microsoft/etcd3",children:"etcd3 documentation"})," for complete configuration options."]}),"\n",(0,r.jsx)(n.h2,{id:"leader-election",children:"Leader Election"}),"\n",(0,r.jsx)(n.p,{children:"The leader election service allows you to determine if the current instance is the leader among multiple instances."}),"\n",(0,r.jsx)(n.h3,{id:"how-it-works",children:"How It Works"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"When the module initializes, each instance attempts to become the leader"}),"\n",(0,r.jsx)(n.li,{children:"Only one instance will be elected as the leader"}),"\n",(0,r.jsx)(n.li,{children:"If the leader instance goes down, etcd automatically elects a new leader"}),"\n",(0,r.jsxs)(n.li,{children:["The ",(0,r.jsx)(n.code,{children:"isLeader()"})," method returns ",(0,r.jsx)(n.code,{children:"true"})," only for the elected leader instance"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"basic-usage",children:"Basic Usage"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { Controller, Get, Inject } from '@nestjs/common';\nimport {\n  InjectEtcdLeaderElectionService,\n  LeaderElectionService,\n} from '@globalart/nestjs-etcd';\n\n@Controller()\nexport class AppController {\n  constructor(\n    @InjectEtcdLeaderElectionService()\n    private readonly leaderElectionService: LeaderElectionService\n  ) {}\n\n  @Get('is-leader')\n  isLeader() {\n    return {\n      isLeader: this.leaderElectionService.isLeader(),\n    };\n  }\n\n  @Get('leader-only-task')\n  async leaderOnlyTask() {\n    if (!this.leaderElectionService.isLeader()) {\n      return { message: 'Not the leader, skipping task' };\n    }\n\n    // Perform leader-only operations\n    return { message: 'Task executed by leader' };\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"use-cases",children:"Use Cases"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Scheduled Tasks"}),": Only the leader instance runs scheduled cron jobs"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Resource Management"}),": Leader manages shared resources"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Health Checks"}),": Leader performs cluster-wide health monitoring"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Cache Warming"}),": Leader preloads cache data"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"leader-election-service-api",children:"Leader Election Service API"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"interface LeaderElectionService {\n  isLeader(): boolean;\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"distributed-locking",children:"Distributed Locking"}),"\n",(0,r.jsx)(n.p,{children:"The distributed lock service allows you to acquire and release locks across multiple instances, ensuring only one instance can execute a critical section at a time."}),"\n",(0,r.jsx)(n.h3,{id:"basic-usage-1",children:"Basic Usage"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { Controller, Post, Body, Inject } from '@nestjs/common';\nimport {\n  InjectEtcdDistributedLockService,\n  DistributedLockService,\n} from '@globalart/nestjs-etcd';\n\n@Controller()\nexport class AppController {\n  constructor(\n    @InjectEtcdDistributedLockService()\n    private readonly distributedLockService: DistributedLockService\n  ) {}\n\n  @Post('process')\n  async processResource(@Body() data: { resourceId: string }) {\n    const lockKey = `process:${data.resourceId}`;\n\n    try {\n      await this.distributedLockService.acquire(lockKey, {\n        ttl: 30, // Lock expires after 30 seconds\n        timeout: 120000, // Wait up to 2 minutes to acquire lock\n        retryInterval: 100, // Retry every 100ms\n      });\n\n      // Critical section - only one instance can execute this\n      await this.processResourceData(data.resourceId);\n\n      return { message: 'Processed successfully', resourceId: data.resourceId };\n    } finally {\n      await this.distributedLockService.release(lockKey);\n    }\n  }\n\n  @Post('check-lock')\n  async checkLock(@Body() data: { resourceId: string }) {\n    const lockKey = `process:${data.resourceId}`;\n    const isLocked = await this.distributedLockService.isLocked(lockKey);\n\n    return {\n      resourceId: data.resourceId,\n      isLocked,\n    };\n  }\n\n  private async processResourceData(resourceId: string) {\n    // Your business logic here\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"lock-options",children:"Lock Options"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Option"}),(0,r.jsx)(n.th,{children:"Type"}),(0,r.jsx)(n.th,{children:"Default"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ttl"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"number"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"30"})}),(0,r.jsx)(n.td,{children:"Time-to-live in seconds. Lock automatically expires after this time"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"timeout"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"number"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"120000"})}),(0,r.jsx)(n.td,{children:"Maximum time in milliseconds to wait for lock acquisition"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"retryInterval"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"number"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"100"})}),(0,r.jsx)(n.td,{children:"Interval in milliseconds between retry attempts"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"lock-methods",children:"Lock Methods"}),"\n",(0,r.jsx)(n.h4,{id:"acquirekey-string-options-lockoptions-promiselock",children:(0,r.jsx)(n.code,{children:"acquire(key: string, options?: LockOptions): Promise<Lock>"})}),"\n",(0,r.jsx)(n.p,{children:"Acquires a lock for the given key. The method will retry until the lock is acquired or the timeout is reached."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const lock = await distributedLockService.acquire('my-resource', {\n  ttl: 60,\n  timeout: 5000,\n  retryInterval: 50,\n});\n"})}),"\n",(0,r.jsx)(n.h4,{id:"releasekey-string-promisevoid",children:(0,r.jsx)(n.code,{children:"release(key: string): Promise<void>"})}),"\n",(0,r.jsx)(n.p,{children:"Releases the lock for the given key. Safe to call even if the lock doesn't exist."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"await distributedLockService.release('my-resource');\n"})}),"\n",(0,r.jsx)(n.h4,{id:"islockedkey-string-promiseboolean",children:(0,r.jsx)(n.code,{children:"isLocked(key: string): Promise<boolean>"})}),"\n",(0,r.jsx)(n.p,{children:"Checks if a lock exists for the given key."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const locked = await distributedLockService.isLocked('my-resource');\nif (locked) {\n  // Resource is currently locked\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"use-cases-1",children:"Use Cases"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Resource Processing"}),": Ensure only one instance processes a specific resource"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Database Migrations"}),": Prevent concurrent migration execution"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Cache Invalidation"}),": Coordinate cache updates across instances"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Rate Limiting"}),": Implement distributed rate limiting"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"best-practices",children:"Best Practices"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Always use try/finally"}),": Ensure locks are released even if errors occur"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Set appropriate TTL"}),": Locks should expire to prevent deadlocks"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use descriptive keys"}),": Include resource identifiers in lock keys"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Handle timeouts"}),": Implement proper error handling for lock acquisition failures"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"api-reference",children:"API Reference"}),"\n",(0,r.jsx)(n.h3,{id:"decorators",children:"Decorators"}),"\n",(0,r.jsx)(n.h4,{id:"injectetcdleaderelectionservice",children:(0,r.jsx)(n.code,{children:"@InjectEtcdLeaderElectionService()"})}),"\n",(0,r.jsxs)(n.p,{children:["Injects the ",(0,r.jsx)(n.code,{children:"LeaderElectionService"})," instance."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"constructor(\n  @InjectEtcdLeaderElectionService()\n  private readonly leaderService: LeaderElectionService\n) {}\n"})}),"\n",(0,r.jsx)(n.h4,{id:"injectetcddistributedlockservice",children:(0,r.jsx)(n.code,{children:"@InjectEtcdDistributedLockService()"})}),"\n",(0,r.jsxs)(n.p,{children:["Injects the ",(0,r.jsx)(n.code,{children:"DistributedLockService"})," instance."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"constructor(\n  @InjectEtcdDistributedLockService()\n  private readonly lockService: DistributedLockService\n) {}\n"})}),"\n",(0,r.jsx)(n.h4,{id:"injectetcdclient",children:(0,r.jsx)(n.code,{children:"@InjectEtcdClient()"})}),"\n",(0,r.jsx)(n.p,{children:"Injects the raw etcd3 client instance for advanced usage."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { Etcd3 } from 'etcd3';\n\nconstructor(\n  @InjectEtcdClient()\n  private readonly etcd: Etcd3\n) {}\n"})}),"\n",(0,r.jsx)(n.h4,{id:"injectetcdid",children:(0,r.jsx)(n.code,{children:"@InjectEtcdId()"})}),"\n",(0,r.jsx)(n.p,{children:"Injects the unique instance ID (UUID) generated for this application instance."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"constructor(\n  @InjectEtcdId()\n  private readonly instanceId: string\n) {}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"services",children:"Services"}),"\n",(0,r.jsx)(n.h4,{id:"leaderelectionservice",children:"LeaderElectionService"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"interface LeaderElectionService {\n  isLeader(): boolean;\n}\n"})}),"\n",(0,r.jsx)(n.h4,{id:"distributedlockservice",children:"DistributedLockService"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"interface DistributedLockService {\n  acquire(key: string, options?: LockOptions): Promise<Lock>;\n  release(key: string): Promise<void>;\n  isLocked(key: string): Promise<boolean>;\n}\n"})}),"\n",(0,r.jsx)(n.h4,{id:"lockoptions",children:"LockOptions"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"interface LockOptions {\n  ttl?: number;\n  timeout?: number;\n  retryInterval?: number;\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"advanced-usage",children:"Advanced Usage"}),"\n",(0,r.jsx)(n.h3,{id:"custom-etcd-operations",children:"Custom etcd Operations"}),"\n",(0,r.jsx)(n.p,{children:"If you need direct access to etcd functionality, inject the etcd client:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { Injectable, Inject } from '@nestjs/common';\nimport { InjectEtcdClient } from '@globalart/nestjs-etcd';\nimport { Etcd3 } from 'etcd3';\n\n@Injectable()\nexport class CustomService {\n  constructor(\n    @InjectEtcdClient()\n    private readonly etcd: Etcd3\n  ) {}\n\n  async getValue(key: string) {\n    return await this.etcd.get(key).string();\n  }\n\n  async setValue(key: string, value: string) {\n    await this.etcd.put(key).value(value);\n  }\n\n  async watchKey(key: string, callback: (value: string) => void) {\n    const watcher = await this.etcd.watch().key(key).create();\n    watcher.on('put', (res) => {\n      callback(res.value.toString());\n    });\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"instance-identification",children:"Instance Identification"}),"\n",(0,r.jsx)(n.p,{children:"Each application instance gets a unique ID that can be used for logging or debugging:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { Injectable, Inject } from '@nestjs/common';\nimport { InjectEtcdId } from '@globalart/nestjs-etcd';\n\n@Injectable()\nexport class MyService {\n  constructor(\n    @InjectEtcdId()\n    private readonly instanceId: string\n  ) {\n    console.log(`Instance ID: ${instanceId}`);\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,r.jsx)(n.h3,{id:"leader-election-errors",children:"Leader Election Errors"}),"\n",(0,r.jsx)(n.p,{children:"Leader election automatically retries on errors. If an error occurs, the service will:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Set ",(0,r.jsx)(n.code,{children:"isLeader()"})," to ",(0,r.jsx)(n.code,{children:"false"})]}),"\n",(0,r.jsx)(n.li,{children:"Log the error"}),"\n",(0,r.jsx)(n.li,{children:"Attempt to rejoin the election"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"lock-acquisition-failures",children:"Lock Acquisition Failures"}),"\n",(0,r.jsx)(n.p,{children:"If a lock cannot be acquired within the timeout period, an error is thrown:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"try {\n  await distributedLockService.acquire('resource', { timeout: 5000 });\n} catch (error) {\n  // Handle timeout - lock could not be acquired\n  console.error('Failed to acquire lock:', error.message);\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"lock-release-errors",children:"Lock Release Errors"}),"\n",(0,r.jsx)(n.p,{children:"Lock release errors are logged but don't throw by default. To handle them explicitly:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"try {\n  await distributedLockService.release('resource');\n} catch (error) {\n  // Handle release error\n  console.error('Failed to release lock:', error);\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"examples",children:"Examples"}),"\n",(0,r.jsxs)(n.p,{children:["See the ",(0,r.jsx)(n.a,{href:"https://github.com/GlobalArtInc/ecosystem/tree/main/examples/etcd3",children:"examples directory"})," for complete working examples."]}),"\n",(0,r.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsx)(n.h3,{id:"connection-issues",children:"Connection Issues"}),"\n",(0,r.jsx)(n.p,{children:"If you're experiencing connection issues:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Verify etcd is running and accessible"}),"\n",(0,r.jsxs)(n.li,{children:["Check the ",(0,r.jsx)(n.code,{children:"hosts"})," configuration in ",(0,r.jsx)(n.code,{children:"etcdOptions"})]}),"\n",(0,r.jsx)(n.li,{children:"Ensure network connectivity between your application and etcd cluster"}),"\n",(0,r.jsx)(n.li,{children:"Check etcd logs for errors"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"lock-not-releasing",children:"Lock Not Releasing"}),"\n",(0,r.jsx)(n.p,{children:"If locks are not releasing properly:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Check if the TTL is too long"}),"\n",(0,r.jsx)(n.li,{children:"Verify the lock key is correct"}),"\n",(0,r.jsxs)(n.li,{children:["Ensure ",(0,r.jsx)(n.code,{children:"release()"})," is called in a ",(0,r.jsx)(n.code,{children:"finally"})," block"]}),"\n",(0,r.jsx)(n.li,{children:"Check etcd cluster health"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"leader-not-electing",children:"Leader Not Electing"}),"\n",(0,r.jsx)(n.p,{children:"If leader election is not working:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Verify the ",(0,r.jsx)(n.code,{children:"leaderElection"})," feature is enabled"]}),"\n",(0,r.jsxs)(n.li,{children:["Check the ",(0,r.jsx)(n.code,{children:"leaderElectionKey"})," configuration"]}),"\n",(0,r.jsx)(n.li,{children:"Ensure multiple instances are running"}),"\n",(0,r.jsx)(n.li,{children:"Check etcd cluster connectivity"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"best-practices-1",children:"Best Practices"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Enable only needed features"}),": Only enable features you actually use"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use descriptive lock keys"}),": Include resource identifiers in lock keys"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Set appropriate TTLs"}),": Prevent deadlocks with reasonable TTL values"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Handle errors gracefully"}),": Implement proper error handling for all operations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Monitor etcd cluster"}),": Ensure etcd cluster health for reliable operations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Use async configuration"}),": Use ",(0,r.jsx)(n.code,{children:"forRootAsync"})," for environment-based configuration"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},7025:(e,n,i)=>{i.d(n,{R:()=>t,x:()=>l});var s=i(3303);const r={},c=s.createContext(r);function t(e){const n=s.useContext(c);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),s.createElement(c.Provider,{value:n},e.children)}}}]);