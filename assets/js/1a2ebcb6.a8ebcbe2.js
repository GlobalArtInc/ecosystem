"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[987],{2490(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>a,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"packages/nestjs-unit-of-work","title":"@globalart/nestjs-unit-of-work","description":"The @globalart/nestjs-unit-of-work package provides a robust implementation of the Unit of Work pattern for NestJS applications using TypeORM. It simplifies transaction management by allowing you to scope database operations within a single transaction using either decorators or a manager service, leveraging AsyncLocalStorage to propagate the transaction context.","source":"@site/content/packages/nestjs-unit-of-work.mdx","sourceDirName":"packages","slug":"/packages/nestjs-unit-of-work","permalink":"/packages/nestjs-unit-of-work","draft":false,"unlisted":false,"editUrl":"https://github.com/GlobalArtInc/ecosystem/tree/main/docs/content/packages/nestjs-unit-of-work.mdx","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5},"sidebar":"tutorialSidebar","previous":{"title":"@globalart/ddd","permalink":"/packages/ddd"}}');var r=t(6259),s=t(3230);const a={sidebar_position:5},i="@globalart/nestjs-unit-of-work",l={},c=[{value:"Installation",id:"installation",level:2},{value:"Setup",id:"setup",level:2},{value:"Usage",id:"usage",level:2},{value:"Declarative Transactions (@UOW)",id:"declarative-transactions-uow",level:3},{value:"Imperative Transactions (UnitOfWorkManager)",id:"imperative-transactions-unitofworkmanager",level:3},{value:"Important: Using Repositories",id:"important-using-repositories",level:2},{value:"API Reference",id:"api-reference",level:2},{value:"UnitOfWorkManager",id:"unitofworkmanager",level:3},{value:"@UOW Decorator",id:"uow-decorator",level:3},{value:"IsolationLevel",id:"isolationlevel",level:3}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"globalartnestjs-unit-of-work",children:"@globalart/nestjs-unit-of-work"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"@globalart/nestjs-unit-of-work"})," package provides a robust implementation of the Unit of Work pattern for NestJS applications using TypeORM. It simplifies transaction management by allowing you to scope database operations within a single transaction using either decorators or a manager service, leveraging ",(0,r.jsx)(n.code,{children:"AsyncLocalStorage"})," to propagate the transaction context."]}),"\n",(0,r.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"npm install @globalart/nestjs-unit-of-work\n"})}),"\n",(0,r.jsx)(n.h2,{id:"setup",children:"Setup"}),"\n",(0,r.jsxs)(n.p,{children:["Import the ",(0,r.jsx)(n.code,{children:"UnitOfWorkModule"})," in your root application module. It is a global module, so you only need to import it once."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { Module } from '@nestjs/common';\nimport { UnitOfWorkModule } from '@globalart/nestjs-unit-of-work';\n\n@Module({\n  imports: [\n    UnitOfWorkModule.forRoot(),\n    // ... other modules\n  ],\n})\nexport class AppModule {}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"usage",children:"Usage"}),"\n",(0,r.jsxs)(n.p,{children:["You can manage transactions in two ways: declaratively using the ",(0,r.jsx)(n.code,{children:"@UOW"})," decorator or imperatively using the ",(0,r.jsx)(n.code,{children:"UnitOfWorkManager"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"declarative-transactions-uow",children:"Declarative Transactions (@UOW)"}),"\n",(0,r.jsxs)(n.p,{children:["The easiest way to make a method transactional is to use the ",(0,r.jsx)(n.code,{children:"@UOW"})," decorator. This automatically starts a transaction before the method executes and commits it afterwards. If an exception is thrown, the transaction is rolled back."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { Controller, Post, Body } from '@nestjs/common';\nimport { UOW, IsolationLevel, UnitOfWorkManager } from '@globalart/nestjs-unit-of-work';\nimport { UserEntity } from './user.entity';\n\n@Controller('users')\nexport class UserController {\n  constructor(private readonly uowManager: UnitOfWorkManager) {}\n\n  @Post()\n  @UOW({ isolationLevel: IsolationLevel.SERIALIZABLE })\n  async createUser(@Body() dto: CreateUserDto) {\n    // IMPORTANT: Get the EntityManager from the current transaction context\n    const em = this.uowManager.getEntityManager();\n    const repo = em.getRepository(UserEntity);\n\n    const user = repo.create(dto);\n    return await repo.save(user);\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"imperative-transactions-unitofworkmanager",children:"Imperative Transactions (UnitOfWorkManager)"}),"\n",(0,r.jsxs)(n.p,{children:["For more granular control, or when you need to perform operations that don't map cleanly to a single method call, use ",(0,r.jsx)(n.code,{children:"UnitOfWorkManager"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { Injectable } from '@nestjs/common';\nimport { UnitOfWorkManager, IsolationLevel } from '@globalart/nestjs-unit-of-work';\nimport { UserEntity } from './user.entity';\n\n@Injectable()\nexport class UserService {\n  constructor(private readonly uowManager: UnitOfWorkManager) {}\n\n  async createUserComplexFlow(dto: CreateUserDto) {\n    return this.uowManager.runInTransaction(async (uow) => {\n      // Access the transactional entity manager directly via uow.conn()\n      const em = uow.conn();\n      const repo = em.getRepository(UserEntity);\n\n      const user = repo.create(dto);\n      await repo.save(user);\n      \n      // ... perform other transactional operations\n      \n      return user;\n    }, IsolationLevel.READ_COMMITTED);\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"important-using-repositories",children:"Important: Using Repositories"}),"\n",(0,r.jsxs)(n.p,{children:["When using ",(0,r.jsx)(n.code,{children:"@InjectRepository()"})," from ",(0,r.jsx)(n.code,{children:"@nestjs/typeorm"}),", the injected repository uses a ",(0,r.jsx)(n.strong,{children:"default, non-transactional connection"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["To ensure your database operations participate in the active Unit of Work transaction, you ",(0,r.jsx)(n.strong,{children:"must"})," obtain the repository or entity manager from the current context:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsxs)(n.strong,{children:["Inside ",(0,r.jsx)(n.code,{children:"runInTransaction"})]}),": Use ",(0,r.jsx)(n.code,{children:"uow.conn().getRepository(Entity)"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsxs)(n.strong,{children:["Inside ",(0,r.jsx)(n.code,{children:"@UOW"})," decorated methods"]}),": Use ",(0,r.jsx)(n.code,{children:"this.uowManager.getEntityManager().getRepository(Entity)"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["If you use the standard ",(0,r.jsx)(n.code,{children:"@InjectRepository"})," inside a transaction, those operations will run outside the transaction, leading to data inconsistencies and race conditions."]}),"\n",(0,r.jsx)(n.h2,{id:"api-reference",children:"API Reference"}),"\n",(0,r.jsx)(n.h3,{id:"unitofworkmanager",children:"UnitOfWorkManager"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"runInTransaction<T>(fn: (uow: TypeOrmUnitOfWork) => Promise<T>, isolationLevel?: IsolationLevel): Promise<T>"}),"\nExecutes the provided function within a transaction."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"getEntityManager(): EntityManager"}),"\nReturns the ",(0,r.jsx)(n.code,{children:"EntityManager"})," for the current active transaction context, or the default manager if no transaction is active."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"uow-decorator",children:"@UOW Decorator"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"@UOW(options?: { isolationLevel?: IsolationLevel })"}),"\nWraps the decorated method in a transaction."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"isolationlevel",children:"IsolationLevel"}),"\n",(0,r.jsx)(n.p,{children:"Supported isolation levels:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"READ_UNCOMMITTED"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"READ_COMMITTED"})," (Default)"]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"REPEATABLE_READ"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"SERIALIZABLE"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},3230(e,n,t){t.d(n,{R:()=>a,x:()=>i});var o=t(1299);const r={},s=o.createContext(r);function a(e){const n=o.useContext(s);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),o.createElement(s.Provider,{value:n},e.children)}}}]);